<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å¿ƒæ¶ˆæ¶ˆä¹ - ç»ˆæä¿®å¤ç‰ˆ</title>
    <style>
        /* å†…è”æ ·å¼ç¡®ä¿ä¸ä¾èµ–å¤–éƒ¨CSSæ–‡ä»¶ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .screen {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .screen.hidden {
            display: none;
        }

        .game-title {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            margin-bottom: 30px;
            text-align: center;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 10px;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(78, 205, 196, 0.6);
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            margin: 0 auto;
            text-align: center;
        }

        .game-screen {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .game-canvas {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            background: #fff;
            border: 3px solid #fff;
        }

        .game-info {
            min-width: 250px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 8px;
        }

        .stat-value {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.5);
        }

        .level-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 15px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            color: #495057;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .level-btn:hover {
            transform: scale(1.1);
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }

        .level-btn.completed {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .level-btn.completed:hover {
            background: linear-gradient(45deg, #1e7e34, #17a2b8);
            transform: scale(1.1);
        }

        .level-btn.completed::after {
            content: 'âœ“';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.8em;
            color: #fff;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 10000;
            text-align: center;
            font-size: 18px;
            max-width: 400px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.5em;
            color: #666;
        }

        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            max-width: 300px;
        }

        /* æµ®åŠ¨æç¤ºä¸å±‚ */
        .tip-layer{position:absolute;left:0;top:0;width:500px;height:500px;pointer-events:none;}
        .floating-tip{position:absolute;font-weight:bold;font-size:18px;color:#fff;text-shadow:0 0 6px #000;opacity:0;animation:tipFloat 1.2s ease-out forwards;}
        @keyframes tipFloat{0%{transform:translate(-50%,0) scale(0.9);opacity:0;}15%{opacity:1;}80%{opacity:1;}100%{transform:translate(-50%,-60px) scale(1.1);opacity:0;}}

        /* éŸ³é¢‘è§£é”æŒ‰é’®åŠ¨ç”» */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px #2196F3; }
            50% { box-shadow: 0 0 20px #2196F3, 0 0 30px #2196F3; }
        }

        .tool-bar{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}
        .tool-btn{padding:8px 14px;font-size:.9em;border-radius:25px;border:none;cursor:pointer;background:#444;color:#fff;transition:.25s;}
        .tool-btn.active{background:#ff9800;box-shadow:0 0 10px #ff9800aa;}
        .line-effect{position:absolute;left:0;top:0;pointer-events:none;}

        @media (max-width: 768px) {
            .game-screen {
                flex-direction: column;
            }
            .game-info {
                min-width: unset;
                width: 100%;
                order: -1;
            }
            .level-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div id="debugInfo" class="debug-info">æ­£åœ¨åŠ è½½æ¸¸æˆ...</div>

    <div class="container">
        <!-- ä¸»èœå•ç•Œé¢ -->
        <div id="mainMenu" class="screen">
            <h1 class="game-title">ğŸ® å¼€å¿ƒæ¶ˆæ¶ˆä¹</h1>
            <p style="text-align: center; font-size: 1.2em; color: #666; margin-bottom: 30px;">
                ç»å…¸ä¸‰æ¶ˆæ¸¸æˆï¼Œ100ä¸ªå…³å¡ç­‰ä½ æŒ‘æˆ˜ï¼
            </p>
            <div class="menu-buttons">
                <button id="startGameBtn" class="btn btn-primary">
                    ğŸš€ å¼€å§‹æ¸¸æˆ
                </button>
                <button id="levelSelectBtn" class="btn btn-secondary">
                    ğŸ¯ é€‰æ‹©å…³å¡
                </button>
                <button id="freePlayBtn" class="btn btn-secondary">
                    â™¾ï¸ è‡ªç”±æ¨¡å¼
                </button>
            </div>
        </div>

        <!-- å…³å¡é€‰æ‹©ç•Œé¢ -->
        <div id="levelSelect" class="screen hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ¯ é€‰æ‹©å…³å¡</h2>
            <div id="levelGrid" class="level-grid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="backToMenuBtn" class="btn btn-secondary">
                    ğŸ  è¿”å›ä¸»èœå•
                </button>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="gameScreen" class="screen game-screen hidden">
            <!-- æ¸¸æˆä¿¡æ¯é¢æ¿ -->
            <div class="game-info">
                <div class="info-section">
                    <h3>ğŸ“Š æ¸¸æˆçŠ¶æ€</h3>
                    <div class="stat-item">
                        <span>å…³å¡</span>
                        <span id="currentLevel" class="stat-value">1</span>
                    </div>
                    <div class="stat-item">
                        <span>åˆ†æ•°</span>
                        <span id="score" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span>å‰©ä½™æ­¥æ•°</span>
                        <span id="moves" class="stat-value">30</span>
                    </div>
                    <div class="stat-item">
                        <span>è¿é”</span>
                        <span id="chainInfo" class="stat-value">-</span>
                    </div>
                </div>

                <div class="info-section">
                    <h3>ğŸ¯ ç›®æ ‡</h3>
                    <div id="objective">è¾¾åˆ° 2000 åˆ†</div>
                </div>

                <div class="info-section">
                    <h3>ğŸ® æ§åˆ¶</h3>
                    <div style="text-align: center;">
                        <button id="restartBtn" class="btn btn-primary">ğŸ”„ é‡å¯</button>
                        <button id="muteBtn" class="btn btn-secondary">ğŸ”Š é™éŸ³</button>
                        <button id="loadAudioBtn" class="btn btn-secondary">ğŸµ éŸ³æ•ˆåŒ…</button>
                        <button id="backToLevelSelectBtn" class="btn btn-secondary">ğŸ“‹ è¿”å›</button>
                        <input id="audioFileInput" type="file" accept="audio/*" multiple style="display:none;" />
                        <div class="tool-bar">
                            <!-- ç§»é™¤é”¤å­ï¼Œä»…ä¿ç•™æ´—ç‰Œä¸å½©è™¹ä¸€æ¬¡æ€§é“å…· -->
                            <button id="toolShuffle" class="tool-btn" title="æ´—ç‰Œ: é‡æ–°æ‰“ä¹±æ£‹ç›˜">ğŸ” æ´—ç‰Œ</button>
                            <button id="toolColorBomb" class="tool-btn" title="ä¸€æ¬¡æ€§ï¼šå°†ç‚¹å‡»çš„å®çŸ³å˜æˆå½©è™¹">ğŸŒˆ å˜å½©è™¹</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆåŒºåŸŸ -->
            <div class="game-area">
                <canvas id="gameCanvas" class="game-canvas" width="500" height="500"></canvas>
                <div id="tipLayer" class="tip-layer"></div>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´ : æ·»åŠ å†…ç½®base64æˆ–å ä½éŸ³æº -->
    <audio id="bgMusic" loop src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto"></audio>
    <audio id="popSound" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto"></audio>
    <audio id="comboSound" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto"></audio>
    <audio id="winSound" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto"></audio>
    <audio id="loseSound" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto"></audio>

    <script>
        // å…¨å±€æ¸¸æˆå¯¹è±¡ - å†…åµŒå®ç°ç¡®ä¿å¯é æ€§
        let GameEngine = null;
        let isGameInitialized = false;
        
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message, type = 'info') {
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML = `[${timestamp}] ${message}`;
            }
            console.log(`[GAME] ${message}`);
        }

        // é”™è¯¯å¤„ç†å‡½æ•°
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-popup';
            errorDiv.innerHTML = `
                <h3>âš ï¸ é”™è¯¯</h3>
                <p>${message}</p>
                <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 10px;">
                    ğŸ”„ åˆ·æ–°é‡è¯•
                </button>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // ç®€åŒ–çš„UIæ§åˆ¶å™¨
        const SimpleUI = {
            currentScreen: 'mainMenu',
            
            showScreen(screenName) {
                debugLog(`åˆ‡æ¢åˆ°å±å¹•: ${screenName}`);
                
                const screens = ['mainMenu', 'levelSelect', 'gameScreen'];
                screens.forEach(screen => {
                    const element = document.getElementById(screen);
                    if (element) {
                        element.classList.add('hidden');
                    }
                });
                
                const targetScreen = document.getElementById(screenName);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    this.currentScreen = screenName;
                    
                    if (screenName === 'levelSelect') {
                        this.createLevelGrid();
                    } else if (screenName === 'gameScreen') {
                        this.initGameScreen();
                    }
                }
            },
            
            createLevelGrid() {
                const grid = document.getElementById('levelGrid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                for (let i = 1; i <= 100; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    btn.textContent = i.toString();
                    btn.onclick = () => this.startLevel(i);
                    
                    // æ£€æŸ¥å…³å¡æ˜¯å¦å·²å®Œæˆ
                    if (GameEngine && GameEngine.unlockedLevels && GameEngine.unlockedLevels[i] && i > 1) {
                        // å¦‚æœå…³å¡iå·²è§£é”ï¼Œè¯´æ˜å…³å¡i-1å·²å®Œæˆï¼ˆé™¤äº†ç¬¬ä¸€å…³ï¼‰
                        if (i === 2 || GameEngine.unlockedLevels[i-1]) {
                            // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæˆè®°å½•
                            const completedLevels = GameEngine.getCompletedLevels();
                            if (completedLevels[i]) {
                                btn.classList.add('completed');
                            }
                        }
                    }
                    
                    // ç¬¬ä¸€å…³å¦‚æœå·²ç»è§£é”äº†ç¬¬äºŒå…³ï¼Œè¯´æ˜å·²å®Œæˆ
                    if (i === 1 && GameEngine && GameEngine.unlockedLevels && GameEngine.unlockedLevels[2]) {
                        const completedLevels = GameEngine.getCompletedLevels();
                        if (completedLevels[1]) {
                            btn.classList.add('completed');
                        }
                    }
                    
                    grid.appendChild(btn);
                }
            },
            
            startLevel(levelId) {
                debugLog(`å¯åŠ¨å…³å¡ ${levelId}`);
                this.showScreen('gameScreen');
                
                if (GameEngine) {
                    GameEngine.startLevel(levelId);
                } else {
                    setTimeout(() => {
                        if (GameEngine) {
                            GameEngine.startLevel(levelId);
                        }
                    }, 500);
                }
            },
            
            initGameScreen() {
                const canvas = document.getElementById('gameCanvas');
                if (canvas && GameEngine) {
                    setTimeout(() => {
                        GameEngine.initCanvas();
                        GameEngine.render();
                    }, 100);
                }
            }
        };

        // åˆå¹¶å¹¶å¢å¼ºæ¸¸æˆå¼•æ“ï¼ˆåŠ å…¥ç‰¹æ®Šå®çŸ³è§¦å‘+é«˜çº§è¯„åˆ†+é™éŸ³+ä¸»é¢˜é¢œè‰²ï¼‰
        class SimpleGameEngine {
            constructor(){
                this.canvas=null; this.ctx=null; this.gridSize=8; this.tileSize=60; this.grid=[]; this.score=0; this.moves=0; this.baseMoves=20; this.levelId=1; this.targetScore=400; this.selectedGem=null; this.isPlaying=false; this.gemTypes=6;
                this.allColors=['#ff5722','#2196f3','#4caf50','#ffeb3b','#9c27b0','#ff9800','#00bcd4','#8bc34a','#e91e63'];
                this.gemColors=this.allColors.slice(0,this.gemTypes);
                this.animating=false; this.particles=[]; this.unlockedLevels=this.loadUnlocked(); this.audio=this.initAudio(); this.isMuted=false; this.comboChain=0; this.lastClearTime=0; this.accentColors=['#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#ffa94d','#9775fa','#74c0fc','#63e6be','#f06595'];
                this.currentChain=0; this.effects=[]; this.currentTool=null;
                this.images=[]; this.audioUnlocked=false; this.colorToolAvailable=true; // æ–°å¢
                this.imageWarned=false; // å›¾ç‰‡åŠ è½½å¤±è´¥æç¤ºåªæ˜¾ç¤ºä¸€æ¬¡
                this.preloadImages();
            }
            preloadImages(){
                console.log("=== å¼€å§‹é¢„åŠ è½½å®çŸ³å›¾ç‰‡ ===");
                this.imagesLoadedCount = 0;
                this.imagesFailedCount = 0;
                this.totalImages = this.allColors.length;
                
                for(let i=0;i<this.totalImages;i++){
                    const img=new Image();
                    // ç§»é™¤crossOriginè®¾ç½®ï¼Œå¯èƒ½å¯¼è‡´æœ¬åœ°æ–‡ä»¶åŠ è½½é—®é¢˜
                    
                    img.onload=()=>{
                        console.log(`âœ“ æˆåŠŸåŠ è½½å®çŸ³å›¾ç‰‡ ${i}: images/gem${i}.png`);
                        img.loaded = true;
                        this.imagesLoadedCount++;
                        this.checkImageLoadComplete();
                    };
                    
                    img.onerror=(e)=>{ 
                        console.error(`âœ— æ— æ³•åŠ è½½å®çŸ³å›¾ç‰‡ ${i}: images/gem${i}.png`, e);
                        img.failed=true; 
                        this.imagesFailedCount++;
                        this.checkImageLoadComplete();
                    };
                    
                    // å…ˆè®¾ç½®å›¾ç‰‡å¯¹è±¡ï¼Œå†è®¾ç½®srcè§¦å‘åŠ è½½
                    this.images[i]=img;
                    // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜é—®é¢˜
                    const timestamp = new Date().getTime();
                    img.src=`images/gem${i}.png?t=${timestamp}`;
                }
                debugLog(`å°è¯•åŠ è½½ ${this.totalImages} ä¸ªå®çŸ³å›¾ç‰‡...`);
            }
            
            checkImageLoadComplete() {
                if(this.imagesLoadedCount + this.imagesFailedCount >= this.totalImages) {
                    const message = `å›¾ç‰‡åŠ è½½å®Œæˆ: æˆåŠŸ ${this.imagesLoadedCount}/${this.totalImages}, å¤±è´¥ ${this.imagesFailedCount}/${this.totalImages}`;
                    console.log("=== " + message + " ===");
                    debugLog(message);
                    
                    if(this.imagesLoadedCount === 0) {
                        debugLog("è­¦å‘Š: æ‰€æœ‰å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨å½©è‰²åœ†å½¢æ›¿ä»£");
                    }
                }
            }
            // éŸ³é¢‘
            initAudio(){
                console.log("=== åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ ===");
                const audioElements = {
                    bg:document.getElementById('bgMusic'),
                    pop:document.getElementById('popSound'),
                    combo:document.getElementById('comboSound'),
                    win:document.getElementById('winSound'),
                    lose:document.getElementById('loseSound')
                };
                
                // æ£€æŸ¥éŸ³é¢‘å…ƒç´ æ˜¯å¦å­˜åœ¨
                Object.keys(audioElements).forEach(key => {
                    if(!audioElements[key]) {
                        console.error(`éŸ³é¢‘å…ƒç´ ä¸å­˜åœ¨: ${key}`);
                    } else {
                        console.log(`âœ“ éŸ³é¢‘å…ƒç´ å·²æ‰¾åˆ°: ${key}`);
                        // è®¾ç½®éŸ³é¢‘å±æ€§
                        audioElements[key].preload = 'auto';
                        audioElements[key].volume = 0.6;
                    }
                });
                
                return audioElements;
            }
            ensureAudioUnlock(){
                if(this.audioUnlocked) return;
                
                console.log("=== è®¾ç½®éŸ³é¢‘è§£é”æœºåˆ¶ ===");
                
                const unlock=()=>{
                    debugLog("ç”¨æˆ·äº¤äº’è§¦å‘ï¼Œå°è¯•è§£é”éŸ³é¢‘...");
                    let unlockedCount = 0;
                    const audioElements = ['bg','pop','combo','win','lose'];
                    let totalElements = audioElements.length;
                    
                    audioElements.forEach(k => { 
                        const a=this.audio[k]; 
                        if(a){ 
                            try{
                                // ä½¿ç”¨é™éŸ³æ–¹å¼è§¦å‘ä»¥é¿å…æ„å¤–çš„å£°éŸ³
                                const originalVolume = a.volume;
                                a.volume = 0.001;
                                
                                // é‡ç½®æ’­æ”¾ä½ç½®
                                a.currentTime = 0;
                                
                                const playPromise = a.play();
                                
                                if(playPromise !== undefined) {
                                    playPromise
                                        .then(() => {
                                            a.pause(); 
                                            a.currentTime=0;
                                            a.volume = originalVolume;
                                            unlockedCount++;
                                            console.log(`âœ“ éŸ³é¢‘ ${k} è§£é”æˆåŠŸ`);
                                            
                                            // å½“æ‰€æœ‰éŸ³é¢‘éƒ½è§£é”åæ˜¾ç¤ºæç¤º
                                            if(unlockedCount === totalElements) {
                                                this.audioUnlocked = true;
                                                this.showTip('ğŸµ éŸ³é¢‘ç³»ç»Ÿå·²è§£é”', 250, 220);
                                                debugLog("éŸ³é¢‘ç³»ç»Ÿå®Œå…¨è§£é”");
                                                this.removeAudioUnlockButton();
                                            }
                                        })
                                        .catch(e => {
                                            console.error(`âœ— éŸ³é¢‘ ${k} è§£é”å¤±è´¥:`, e);
                                            unlockedCount++;
                                            if(unlockedCount === totalElements) {
                                                this.audioUnlocked = true; // å³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿæ ‡è®°ä¸ºå·²å°è¯•
                                                this.showTip('ğŸµ éŸ³é¢‘éƒ¨åˆ†è§£é”', 250, 220);
                                                this.removeAudioUnlockButton();
                                            }
                                        });
                                } else {
                                    // æ—§ç‰ˆæµè§ˆå™¨ä¸è¿”å›Promise
                                    setTimeout(() => {
                                        a.pause(); 
                                        a.currentTime=0;
                                        a.volume = originalVolume;
                                    }, 100);
                                    unlockedCount++;
                                    if(unlockedCount === totalElements) {
                                        this.audioUnlocked = true;
                                        this.removeAudioUnlockButton();
                                    }
                                }
                            } catch(e) {
                                console.error(`å°è¯•è§£é”éŸ³é¢‘ ${k} å‡ºé”™:`, e);
                                unlockedCount++;
                                if(unlockedCount === totalElements) {
                                    this.audioUnlocked = true;
                                    this.removeAudioUnlockButton();
                                }
                            } 
                        } else {
                            console.warn(`éŸ³é¢‘å…ƒç´  ${k} ä¸å­˜åœ¨`);
                            unlockedCount++;
                            if(unlockedCount === totalElements) {
                                this.audioUnlocked = true;
                                this.removeAudioUnlockButton();
                            }
                        }
                    });
                };
                
                // ç»‘å®šå¤šç§äº‹ä»¶ç¡®ä¿å…¼å®¹æ€§
                document.addEventListener('click', unlock, {once:true});
                document.addEventListener('touchstart', unlock, {once:true});
                document.addEventListener('keydown', unlock, {once:true});
                
                // åˆ›å»ºæ˜æ˜¾çš„éŸ³é¢‘è§£é”æŒ‰é’®
                this.createAudioUnlockButton(unlock);
            }
            
            createAudioUnlockButton(unlockFunction) {
                // ç§»é™¤å·²å­˜åœ¨çš„æŒ‰é’®
                this.removeAudioUnlockButton();
                
                const unlockBtn = document.createElement('button');
                unlockBtn.id = 'audioUnlockButton';
                unlockBtn.textContent = 'ğŸµ ç‚¹å‡»è§£é”éŸ³é¢‘';
                unlockBtn.className = 'btn btn-primary';
                unlockBtn.style.cssText = `
                    position: fixed;
                    top: 10px;
                    left: 10px;
                    z-index: 10000;
                    animation: pulse 2s infinite, glow 3s infinite;
                    font-weight: bold;
                    border: 2px solid #fff;
                `;
                
                unlockBtn.onclick = () => {
                    unlockFunction();
                };
                
                document.body.appendChild(unlockBtn);
                
                // 10ç§’åè‡ªåŠ¨éšè—æŒ‰é’®
                setTimeout(() => {
                    this.removeAudioUnlockButton();
                }, 10000);
            }
            
            removeAudioUnlockButton() {
                const existingBtn = document.getElementById('audioUnlockButton');
                if(existingBtn && existingBtn.parentNode) {
                    existingBtn.parentNode.removeChild(existingBtn);
                }
            }
            loadAudioPack(name){ 
                console.log(`=== å°è¯•åŠ è½½éŸ³é¢‘åŒ…: ${name} ===`);
                debugLog(`å¼€å§‹åŠ è½½éŸ³é¢‘åŒ…: ${name}`);
                
                if(name==='9439'){ 
                    const map={bg:'bg',pop:'pop',combo:'combo',win:'win',lose:'lose'}; 
                    let loadedCount = 0;
                    let errorCount = 0;
                    let totalCount = Object.keys(map).length;
                    
                    const checkComplete = () => {
                        if(loadedCount + errorCount >= totalCount) {
                            const message = `éŸ³é¢‘åŒ…åŠ è½½å®Œæˆ: æˆåŠŸ ${loadedCount}/${totalCount}, å¤±è´¥ ${errorCount}/${totalCount}`;
                            console.log("=== " + message + " ===");
                            debugLog(message);
                            
                            if(loadedCount > 0) {
                                this.showTip('ğŸµ 9439éŸ³æ•ˆåŒ…åŠ è½½å®Œæˆ',250,220);
                            } else {
                                this.showTip('âš ï¸ éŸ³æ•ˆåŒ…åŠ è½½å¤±è´¥',250,220);
                            }
                        }
                    };
                    
                    for(const k in map){ 
                        const el=this.audio[k]; 
                        if(el){ 
                            const url = `audio/9439/${map[k]}.mp3`;
                            console.log(`å¼€å§‹åŠ è½½éŸ³é¢‘: ${url}`);
                            
                            // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜é—®é¢˜
                            const timestamp = new Date().getTime();
                            const urlWithTimestamp = `${url}?t=${timestamp}`;
                            
                            el.oncanplaythrough = () => {
                                console.log(`âœ“ éŸ³é¢‘åŠ è½½æˆåŠŸ: ${url}`);
                                loadedCount++;
                                checkComplete();
                            };
                            
                            el.onloadeddata = () => {
                                console.log(`âœ“ éŸ³é¢‘æ•°æ®åŠ è½½: ${url}`);
                            };
                            
                            el.onerror = (e) => {
                                console.error(`âœ— åŠ è½½éŸ³é¢‘å¤±è´¥: ${url}`, e);
                                errorCount++;
                                checkComplete();
                            };
                            
                            // è®¾ç½®æºå¹¶å¼€å§‹åŠ è½½
                            try {
                                el.src = urlWithTimestamp; 
                                el.load();
                            } catch(e) {
                                console.error(`è®¾ç½®éŸ³é¢‘æºå¤±è´¥: ${url}`, e);
                                errorCount++;
                                checkComplete();
                            }
                        } else {
                            console.error(`éŸ³é¢‘å…ƒç´ ä¸å­˜åœ¨: ${k}`);
                            errorCount++;
                            checkComplete();
                        }
                    }
                    
                    // ç¡®ä¿éŸ³é¢‘è§£é”
                    this.ensureAudioUnlock(); 
                } else {
                    console.warn(`æœªçŸ¥çš„éŸ³é¢‘åŒ…: ${name}`);
                    debugLog(`æœªçŸ¥çš„éŸ³é¢‘åŒ…: ${name}`);
                }
            }
            play(name,vol=0.6){ 
                if(this.isMuted) {
                    //console.log(`éŸ³é¢‘å·²é™éŸ³ï¼Œè·³è¿‡æ’­æ”¾: ${name}`);
                    return;
                } 
                
                const a=this.audio[name]; 
                if(!a) {
                    console.warn(`éŸ³é¢‘å…ƒç´ ä¸å­˜åœ¨: ${name}`);
                    return;
                } 
                
                try{ 
                    // æ£€æŸ¥éŸ³é¢‘æ˜¯å¦å¯ä»¥æ’­æ”¾
                    if(a.readyState >= 2) { // HAVE_CURRENT_DATA æˆ–æ›´é«˜
                        a.currentTime=0; 
                        a.volume=vol; 
                        
                        const playPromise = a.play();
                        if(playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    //console.log(`éŸ³é¢‘æ’­æ”¾æˆåŠŸ: ${name}`);
                                })
                                .catch(error => {
                                    console.error(`æ’­æ”¾${name}å¤±è´¥:`, error);
                                    // å¦‚æœæ˜¯è‡ªåŠ¨æ’­æ”¾é™åˆ¶å¯¼è‡´çš„é”™è¯¯ï¼Œå°è¯•è§£é”éŸ³é¢‘
                                    if(error.name === "NotAllowedError") {
                                        console.log("æ£€æµ‹åˆ°è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼Œå°è¯•è§£é”éŸ³é¢‘");
                                        this.ensureAudioUnlock();
                                    }
                                });
                        }
                    } else {
                        console.warn(`éŸ³é¢‘ ${name} å°šæœªå‡†å¤‡å¥½æ’­æ”¾ (readyState: ${a.readyState})`);
                    }
                }catch(e){
                    console.error(`æ’­æ”¾${name}å¼‚å¸¸:`, e);
                } 
            }
            toggleMute(){ this.isMuted=!this.isMuted; const btn=document.getElementById('muteBtn'); if(btn) btn.textContent=this.isMuted?'ğŸ”‡ è§£é™¤é™éŸ³':'ğŸ”Š é™éŸ³'; if(!this.isMuted){ this.play('bg',0.4);} else { Object.values(this.audio).forEach(a=>{try{a.pause();}catch(e){}});} }
            // å­˜æ¡£
            loadUnlocked(){ try{ const d=localStorage.getItem('match3_unlocked'); if(d) return JSON.parse(d);}catch(e){} return {1:true}; }
            saveUnlocked(){ try{ localStorage.setItem('match3_unlocked',JSON.stringify(this.unlockedLevels)); }catch(e){} }
            
            // å®Œæˆå…³å¡è®°å½•
            getCompletedLevels(){ try{ const d=localStorage.getItem('match3_completed'); if(d) return JSON.parse(d);}catch(e){} return {}; }
            saveCompletedLevel(levelId){ try{ const completed=this.getCompletedLevels(); completed[levelId]=true; localStorage.setItem('match3_completed',JSON.stringify(completed)); }catch(e){} }
            // ç”»å¸ƒ
            initCanvas(){ if(this.canvas) return true; this.canvas=document.getElementById('gameCanvas'); if(!this.canvas) return false; this.ctx=this.canvas.getContext('2d'); if(!this.ctx) return false; const size=Math.min(this.canvas.width,this.canvas.height); this.tileSize=size/this.gridSize; this.canvas.onclick=e=>this.handleClick(e); requestAnimationFrame(()=>this.render()); return true; }
            // å…³å¡é…ç½®
            levelConfig(id){ 
                // æ›´å¹³æ»‘çš„éš¾åº¦æ›²çº¿ï¼Œé€‚åº”100å…³
                const target = 400 + (id-1) * 120 + Math.floor((id-1)/10) * 200; // æ¯10å…³å¢åŠ é¢å¤–éš¾åº¦
                const moves = Math.max(15, this.baseMoves - Math.floor((id-1)/5)); // æ›´ç¼“æ…¢çš„æ­¥æ•°å‡å°‘
                return {target, moves}; 
            }
            setThemeColor(id){ const color=this.accentColors[(id-1)%this.accentColors.length]; document.body.style.background=`linear-gradient(135deg, ${color} 0%, #222 100%)`; }
            startLevel(id){ if(!this.initCanvas()){ showError('ç”»å¸ƒåˆå§‹åŒ–å¤±è´¥'); return;} if(id!==0 && !this.unlockedLevels[id]){ alert('è¯¥å…³å¡æœªè§£é”'); return;} this.levelId=id===0?'è‡ªç”±':id; const cfg=id===0?{target:0,moves:9999}:this.levelConfig(id); if(id!==0){ this.gemTypes=Math.min(3+Math.floor((id-1)/8),this.allColors.length); this.gemColors=this.allColors.slice(0,this.gemTypes);} this.targetScore=cfg.target; this.moves=cfg.moves; this.score=0; this.selectedGem=null; this.isPlaying=true; this.comboChain=0; this.currentChain=0; this.effects=[]; this.currentTool=null; this.colorToolAvailable=true; // é‡ç½®ä¸€æ¬¡æ€§å½©è™¹å·¥å…·
                const colorBtn=document.getElementById('toolColorBomb'); if(colorBtn){ colorBtn.disabled=false; colorBtn.classList.remove('active'); colorBtn.style.opacity='1'; }
                this.generateInitialGrid(); this.placeObstacles(); this.updateObjectiveUI(); this.updateUI(); this.setThemeColor(id===0?1:id); this.play('bg',0.3); this.ensureAudioUnlock();
            }
            updateObjectiveUI(){ const l=document.getElementById('currentLevel'); const o=document.getElementById('objective'); if(l) l.textContent=this.levelId; if(o) o.textContent=this.levelId==='è‡ªç”±'?'è‡ªç”±æ¨¡å¼ï¼šæ— é™åˆ†æ•°':`ç›®æ ‡åˆ†æ•°: ${this.targetScore}`; }
            // åˆå§‹åŒ–æ£‹ç›˜é¿å…åˆå§‹åŒ¹é…
            generateInitialGrid(){ this.grid=[]; for(let y=0;y<this.gridSize;y++){ this.grid[y]=[]; for(let x=0;x<this.gridSize;x++){ let type; do{ type=Math.floor(Math.random()*this.gemTypes);} while(this.causesImmediateMatch(x,y,type)); this.grid[y][x]={type,x,y,special:null}; } } }
            causesImmediateMatch(x,y,type){ if(x>=2 && this.grid[y][x-1] && this.grid[y][x-2] && this.grid[y][x-1].type===type && this.grid[y][x-2].type===type) return true; if(y>=2 && this.grid[y-1] && this.grid[y-2] && this.grid[y-1][x] && this.grid[y-2][x] && this.grid[y-1][x].type===type && this.grid[y-2][x].type===type) return true; return false; }
            // éšœç¢æ”¾ç½®ï¼šstone(é˜»æŒ¡) ä¸ å†°(é”å®šå®çŸ³)
            placeObstacles(){ 
                if(this.levelId==='è‡ªç”±') return; 
                // æ›´å¹³æ»‘çš„éšœç¢å¢é•¿æ›²çº¿ï¼Œé€‚åº”100å…³
                const stoneProb = Math.min(0.02 + (this.levelId-1) * 0.002, 0.15); 
                const iceProb = Math.min(0.03 + (this.levelId-1) * 0.003, 0.25); 
                for(let y=0;y<this.gridSize;y++) 
                    for(let x=0;x<this.gridSize;x++){ 
                        if(Math.random()<stoneProb){ 
                            this.grid[y][x]={obstacle:'stone',hp:2,x,y}; 
                        } else if(Math.random()<iceProb){ 
                            const g=this.grid[y][x]; 
                            if(g) g.locked=1; 
                        } 
                    } 
            }
            // è¾“å…¥
            handleClick(e){ if(!this.isPlaying || this.animating) return; const r=this.canvas.getBoundingClientRect(); const x=Math.floor((e.clientX-r.left)/this.tileSize); const y=Math.floor((e.clientY-r.top)/this.tileSize); if(x<0||x>=this.gridSize||y<0||y>=this.gridSize) return; if(this.currentTool){ this.useTool(x,y); return;} const cell=this.grid[y][x]; if(cell && cell.locked){ this.showTip('ğŸ”’ è¢«å†°å°',(x+0.5)*this.tileSize,(y+0.5)*this.tileSize); return;} if(!this.selectedGem){ this.selectedGem={x,y}; } else { if(this.selectedGem.x===x && this.selectedGem.y===y){ this.selectedGem=null; } else if(this.isAdjacent(this.selectedGem,{x,y})){ this.attemptSwap(this.selectedGem,{x,y}); this.selectedGem=null; } else { this.selectedGem={x,y}; } } }
    // é“å…·
    useTool(x,y){ const tool=this.currentTool; const cell=this.grid[y][x]; if(tool==='color'){ if(!this.colorToolAvailable){ this.showTip('ğŸš« å·²ä½¿ç”¨',(x+0.5)*this.tileSize,(y+0.5)*this.tileSize); this.afterToolAffect(); return;} if(cell && !cell.obstacle){ cell.special='color'; this.showTip('ğŸŒˆ',(x+0.5)*this.tileSize,(y+0.5)*this.tileSize); this.colorToolAvailable=false; const btn=document.getElementById('toolColorBomb'); if(btn){ btn.disabled=true; btn.classList.remove('active'); btn.style.opacity='.45'; } } }
        else if(tool==='shuffle'){ if(this.shuffleBoard()) this.showTip('ğŸ” å·²æ´—ç‰Œ',250,240); }
        this.afterToolAffect(); }
    afterToolAffect(){ this.currentTool=null; this.highlightTools(); this.updateUI(); }
    activateTool(name){ if(this.animating) return; this.currentTool=this.currentTool===name?null:name; this.highlightTools(); }
    highlightTools(){ const map={toolShuffle:'shuffle',toolColorBomb:'color'}; Object.keys(map).forEach(id=>{ const el=document.getElementById(id); if(el){ if(this.currentTool===map[id]) el.classList.add('active'); else el.classList.remove('active'); } }); }
    // åŸºç¡€é€»è¾‘
    isAdjacent(a,b){ return (Math.abs(a.x-b.x)+Math.abs(a.y-b.y))===1; }
    attemptSwap(a,b){ const g1=this.grid[a.y][a.x]; const g2=this.grid[b.y][b.x]; if((g1&&g1.locked)||(g2&&g2.locked)) { this.showTip('ğŸ”’ æ— æ³•ç§»åŠ¨',(b.x+0.5)*this.tileSize,(b.y+0.5)*this.tileSize); return; } this.swapRaw(a,b); const s1=this.grid[a.y][a.x]; const s2=this.grid[b.y][b.x]; const specialInvolved=s1.special||s2.special; let groups=this.findMatches(); if(groups.length===0 && specialInvolved){ this.moves--; this.triggerSpecialSwap(s1,s2); this.updateUI(); return;} if(groups.length===0){ this.swapRaw(a,b); this.play('combo',0.2);} else { this.moves--; this.processMatches(groups,1);} this.updateUI(); }
    swapRaw(a,b){ const g1=this.grid[a.y][a.x]; const g2=this.grid[b.y][b.x]; this.grid[a.y][a.x]=g2; if(g2){g2.x=a.x; g2.y=a.y;} this.grid[b.y][b.x]=g1; if(g1){g1.x=b.x; g1.y=b.y;} }
    triggerSpecialSwap(g1,g2){ const isLine=g=>g&&(g.special==='lineH'||g.special==='lineV'); if(g1.special==='color'&&g2.special==='color'){ const cells=[]; for(let y=0;y<this.gridSize;y++)for(let x=0;x<this.gridSize;x++) cells.push({x,y}); this.clearCells(cells,'åŒå½©è™¹å…¨æ¸…',80); this.showTip('ğŸŒˆğŸŒˆ å…¨æ¿æ¸…é™¤!',250,250); this.cascade(1); return; } if((g1.special==='color'&&isLine(g2))||(g2.special==='color'&&isLine(g1))){ const lineGem=g1.special==='color'?g2:g1; const targetType=lineGem.type; const cellsSet=new Set(); for(let y=0;y<this.gridSize;y++) for(let x=0;x<this.gridSize;x++){ const cell=this.grid[y][x]; if(cell && cell.type===targetType){ if(lineGem.special==='lineH'){ for(let cx=0;cx<this.gridSize;cx++) cellsSet.add(y+','+cx);} else { for(let cy=0;cy<this.gridSize;cy++) cellsSet.add(cy+','+x);} } } const cells=[]; cellsSet.forEach(k=>{ const [y,x]=k.split(',').map(Number); cells.push({x,y}); }); this.clearCells(cells,'å½©è™¹çº¿æ€§é—ªç”µ',90); this.showTip('ğŸŒˆâš¡ å½©è™¹çº¿æ€§é—ªç”µ!',250,250); this.cascade(1); return;} if(g1.special==='color'||g2.special==='color'){ const target=g1.special==='color'?g2:g1; const cells=[]; for(let y=0;y<this.gridSize;y++) for(let x=0;x<this.gridSize;x++) if(this.grid[y][x].type===target.type) cells.push({x,y}); cells.push({x:target.x,y:target.y}); this.clearCells(cells,'å½©è™¹æ¸…è‰²',70); this.showTip('ğŸŒˆ æ¸…é™¤é¢œè‰²!',250,250); this.cascade(1); return; } if(isLine(g1)&&isLine(g2)){ const rows=new Set([g1.y,g2.y]); const cols=new Set([g1.x,g2.x]); [...rows].forEach(r=>{ if(r-1>=0) rows.add(r-1); if(r+1<this.gridSize) rows.add(r+1); }); [...cols].forEach(c=>{ if(c-1>=0) cols.add(c-1); if(c+1<this.gridSize) cols.add(c+1); }); const cells=[]; rows.forEach(r=>{ this.addLineEffect('h',r); for(let x=0;x<this.gridSize;x++) cells.push({x,y:r});}); cols.forEach(c=>{ this.addLineEffect('v',c); for(let y=0;y<this.gridSize;y++) cells.push({x:c,y});}); this.clearCells(cells,'åŒçº¿æ€§å¼ºåŒ–',65); this.showTip('âš¡âš¡ åŒçº¿æ€§å¼ºåŒ–!',250,250); this.cascade(1); return;} const toClear=[]; if(isLine(g1)) this.collectLine(g1,toClear); if(isLine(g2)) this.collectLine(g2,toClear); this.clearCells(toClear,'çº¿æ€§æ¶ˆé™¤',60); this.showTip('âš¡ çº¿æ€§æ¶ˆé™¤',250,250); this.cascade(1); }
    collectLine(g,arr){ if(!g) return; if(g.special==='lineH'){ this.addLineEffect('h',g.y); for(let x=0;x<this.gridSize;x++) arr.push({x,y:g.y}); } else if(g.special==='lineV'){ this.addLineEffect('v',g.x); for(let y=0;y<this.gridSize;y++) arr.push({x:g.x,y}); } }
    addLineEffect(orientation,index){ this.effects.push({orientation,index,progress:0}); }
    clearCells(cells,reason,base=50){ const uniq=new Set(); cells.forEach(c=>uniq.add(c.x+','+c.y)); let count=0; uniq.forEach(key=>{ const [xS,yS]=key.split(','); const x=+xS,y=+yS; const cell=this.grid[y]&&this.grid[y][x]; if(!cell) return; if(cell.obstacle==='stone'){ cell.hp--; if(cell.hp<=0){ this.spawnParticles(x,y,{type:0}); this.grid[y][x]=null; count++; } return; } if(cell.locked){ cell.locked--; this.spawnParticles(x,y,cell); count++; return; } this.spawnParticles(x,y,cell); this.grid[y][x]=null; count++; }); const gained=count*base; this.score+=gained; this.play('pop',0.55); this.updateUI(); }
    findMatches(){ const groups=[]; // æ°´å¹³
        for(let y=0;y<this.gridSize;y++){ let run=[]; for(let x=0;x<this.gridSize;x++){ const c=this.grid[y][x]; if(!c||c.obstacle==='stone'){ if(run.length>=3) groups.push({cells:run.slice(),orientation:'h'}); run=[]; continue;} if(run.length===0||c.type===run[run.length-1].type) run.push(c); else { if(run.length>=3) groups.push({cells:run.slice(),orientation:'h'}); run=[c]; } } if(run.length>=3) groups.push({cells:run.slice(),orientation:'h'}); }
        for(let x=0;x<this.gridSize;x++){ let run=[]; for(let y=0;y<this.gridSize;y++){ const c=this.grid[y][x]; if(!c||c.obstacle==='stone'){ if(run.length>=3) groups.push({cells:run.slice(),orientation:'v'}); run=[]; continue;} if(run.length===0||c.type===run[run.length-1].type) run.push(c); else { if(run.length>=3) groups.push({cells:run.slice(),orientation:'v'}); run=[c]; } } if(run.length>=3) groups.push({cells:run.slice(),orientation:'v'}); }
        return groups; }
    processMatches(groups,chain){ if(groups.length===0) return; this.animating=true; const toRemove=new Set(); const specials=[]; let baseScore=0; groups.forEach(g=>{ const len=g.cells.length; g.cells.forEach(c=>toRemove.add(c.y+','+c.x)); if(len===3) baseScore+=60; else if(len===4){ baseScore+=120; const p=g.cells[1]; specials.push({x:p.x,y:p.y,type:p.type,special:g.orientation==='h'?'lineH':'lineV'}); } else if(len>=5){ baseScore+=200+(len-5)*40; const p=g.cells[2]; specials.push({x:p.x,y:p.y,type:p.type,special:'color'}); } }); const perGemBonus=toRemove.size*10; baseScore+=perGemBonus; const multiplier=1+(chain-1)*0.5; const gained=Math.floor(baseScore*multiplier); this.score+=gained; this.currentChain=chain; this.play(chain>1?'combo':'pop', chain>1?0.9:0.6); toRemove.forEach(k=>{ const [y,x]=k.split(',').map(Number); this.spawnParticles(x,y,this.grid[y][x]); this.grid[y][x]=null; }); specials.forEach(sp=>{ this.grid[sp.y][sp.x]={type:sp.type,x:sp.x,y:sp.y,special:sp.special}; }); this.showTip(`+${gained}${chain>1?` (è¿é”x${multiplier.toFixed(1)})`:''}`,250,260-(chain-1)*28); this.updateUI(); this.cascade(chain); }
    cascade(chain){ for(let x=0;x<this.gridSize;x++){ for(let y=this.gridSize-1;y>=0;y--){ if(this.grid[y][x]==null){ for(let k=y-1;k>=0;k--){ if(this.grid[k][x]!=null){ this.grid[y][x]=this.grid[k][x]; this.grid[y][x].y=y; this.grid[k][x]=null; break; } } } } } for(let y=0;y<this.gridSize;y++) for(let x=0;x<this.gridSize;x++) if(this.grid[y][x]==null) this.grid[y][x]={type:Math.floor(Math.random()*this.gemTypes),x,y,special:null}; const newGroups=this.findMatches(); if(newGroups.length>0){ setTimeout(()=>this.processMatches(newGroups,chain+1),220);} else { this.animating=false; setTimeout(()=>{ this.currentChain=0; this.updateUI(); },600); this.ensureMoves(); this.postMoveCheck(); } }
    hasPossibleMoves(){ const trySwap=(ax,ay,bx,by)=>{ const A=this.grid[ay][ax]; const B=this.grid[by][bx]; if(!A||!B||A.obstacle==='stone'||B.obstacle==='stone') return false; this.grid[ay][ax]=B; this.grid[by][bx]=A; const ok=this.findMatches().length>0; this.grid[ay][ax]=A; this.grid[by][bx]=B; return ok; }; for(let y=0;y<this.gridSize;y++) for(let x=0;x<this.gridSize;x++){ if(x+1<this.gridSize && trySwap(x,y,x+1,y)) return true; if(y+1<this.gridSize && trySwap(x,y,x,y+1)) return true; } return false; }
    shuffleBoard(){ const flat=[]; for(let y=0;y<this.gridSize;y++) for(let x=0;x<this.gridSize;x++) if(this.grid[y][x]) flat.push(this.grid[y][x]); let attempts=0; while(attempts<60){ for(let i=flat.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [flat[i],flat[j]]=[flat[j],flat[i]]; } let idx=0; for(let y=0;y<this.gridSize;y++) for(let x=0;x<this.gridSize;x++){ const g=flat[idx++]; g.x=x; g.y=y; this.grid[y][x]=g; } if(this.findMatches().length===0 && this.hasPossibleMoves()) return true; attempts++; } return false; }
    ensureMoves(){ if(!this.hasPossibleMoves()){ const ok=this.shuffleBoard(); if(ok) this.showTip('ğŸ” æ— å¯è¡ŒåŠ¨ä½œï¼Œè‡ªåŠ¨æ´—ç‰Œ',250,240); else this.showTip('âš ï¸ æ´—ç‰Œå¤±è´¥',250,240);} }
    postMoveCheck(){ if(this.levelId!=='è‡ªç”±' && this.score>=this.targetScore){ this.levelWin(); } else if(this.moves<=0 && this.levelId!=='è‡ªç”±'){ this.levelFail(); } }
    levelWin(){ 
        this.play('win',0.9); 
        
        // ä¿å­˜å®Œæˆè®°å½•
        this.saveCompletedLevel(this.levelId);
        
        alert(`å…³å¡ ${this.levelId} å®Œæˆ! åˆ†æ•°: ${this.score}`); 
        if(!this.unlockedLevels[this.levelId+1]){ 
            this.unlockedLevels[this.levelId+1]=true; 
            this.saveUnlocked(); 
        } 
        this.isPlaying=false; 
        SimpleUI.showScreen('levelSelect'); 
    }
    levelFail(){ this.play('lose',0.9); alert(`å…³å¡å¤±è´¥ï¼åˆ†æ•°: ${this.score}`); this.isPlaying=false; SimpleUI.showScreen('levelSelect'); }
    // è§†è§‰
    spawnParticles(x,y,gem){ if(!gem) return; const px=x*this.tileSize+this.tileSize/2; const py=y*this.tileSize+this.tileSize/2; for(let i=0;i<10;i++){ this.particles.push({x:px,y:py,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:35,color:this.gemColors[gem.type%this.gemColors.length]}); } }
    updateParticles(){ this.particles=this.particles.filter(p=>p.life>0); this.particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.07; p.life--; }); this.effects=this.effects.filter(e=>e.progress<1); this.effects.forEach(e=>{ e.progress+=0.04; }); }
    updateUI(){ const s=document.getElementById('score'); const m=document.getElementById('moves'); if(s) s.textContent=this.score; if(m) m.textContent=(this.levelId==='è‡ªç”±')?'âˆ':this.moves; const c=document.getElementById('chainInfo'); if(c) c.textContent=this.currentChain>1?`${this.currentChain}è¿ (x${(1+(this.currentChain-1)*0.5).toFixed(1)})`:'-'; }
    showTip(text,x,y){ const layer=document.getElementById('tipLayer'); if(!layer) return; const d=document.createElement('div'); d.className='floating-tip'; d.textContent=text; d.style.left=x+'px'; d.style.top=y+'px'; layer.appendChild(d); setTimeout(()=>{ if(d.parentNode) d.parentNode.removeChild(d); },1300); }
            drawGem(x,y,type){ 
                const gem=this.grid[y][x]; 
                if(!gem) return; 
                
                const img=this.images[type%this.images.length]; 
                const cx=x*this.tileSize; 
                const cy=y*this.tileSize; 
                
                // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å¯ç”¨ - æ›´ä¸¥æ ¼çš„æ£€æŸ¥
                const canDrawImg = img && img.complete && !img.failed && img.naturalWidth>0 && img.loaded && img.src; 
                
                if(canDrawImg){ 
                    try {
                        this.ctx.drawImage(img, cx+4, cy+4, this.tileSize-8, this.tileSize-8);
                        // ç»˜åˆ¶ç‰¹æ®Šæ ‡è®°
                        this.drawSpecialMarkers(gem, cx, cy);
                    } catch(e) {
                        console.error(`ç»˜åˆ¶å›¾ç‰‡å¤±è´¥ (type=${type}):`, e);
                        this.drawFallbackGem(cx, cy, type, gem);
                    }
                } else { 
                    // å›é€€åˆ°é¢œè‰²åœ†å½¢
                    this.drawFallbackGem(cx, cy, type, gem);
                    
                    // åªåœ¨ç¬¬ä¸€æ¬¡æ˜¾ç¤ºæç¤ºï¼Œé¿å…åˆ·å±
                    if(!this.imageWarned){ 
                        this.showTip('ğŸ–¼ï¸ ä½¿ç”¨é¢œè‰²æ›¿ä»£å®çŸ³å›¾ç‰‡', 250, 200); 
                        this.imageWarned=true; 
                        console.log(`ä½¿ç”¨é¢œè‰²æ›¿ä»£å®çŸ³å›¾ç‰‡ (æ£€æµ‹åˆ° ${this.imagesLoadedCount} å¼ å›¾ç‰‡åŠ è½½æˆåŠŸ)`);
                    }
                }
            }        // æå–ç»˜åˆ¶å¤‡ç”¨å®çŸ³çš„æ–¹æ³•
        drawFallbackGem(cx, cy, type, gem) {
            const r=this.tileSize/2-6; 
            const mx=cx+this.tileSize/2; 
            const my=cy+this.tileSize/2; 
            this.ctx.fillStyle=this.gemColors[type%this.gemColors.length]; 
            this.ctx.beginPath(); 
            this.ctx.arc(mx, my, r, 0, Math.PI*2); 
            this.ctx.fill();
            
            // ç»˜åˆ¶ä¸€ä¸ªç™½è‰²è¾¹æ¡†ï¼Œè®©å®çŸ³æ›´æ˜“åŒºåˆ†
            this.ctx.strokeStyle = '#fff';
            this.ctx.lineWidth = 2;
            this.ctx.stroke();
            
            // æ˜¾ç¤ºå®çŸ³ç±»å‹ç¼–å·å¸®åŠ©è°ƒè¯•
            this.ctx.fillStyle = '#fff';
            this.ctx.font = '14px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.fillText(type.toString(), mx, my);
            
            // ç»˜åˆ¶ç‰¹æ®Šæ ‡è®°
            if(gem) {
                this.drawSpecialMarkers(gem, cx, cy);
            }
            
            // é«˜å…‰
            this.ctx.fillStyle='rgba(255,255,255,0.35)'; 
            this.ctx.beginPath(); 
            this.ctx.arc(cx+this.tileSize/2 - this.tileSize/6, cy+this.tileSize/2 - this.tileSize/6, this.tileSize/6,0,Math.PI*2); 
            this.ctx.fill();
        }
        
        // åˆ†ç¦»ç‰¹æ®Šæ ‡è®°ç»˜åˆ¶é€»è¾‘
        drawSpecialMarkers(gem, cx, cy) {
            if(!gem.special) return;
            
            this.ctx.save(); 
            this.ctx.strokeStyle='#fff'; 
            this.ctx.lineWidth=4;
            
            if(gem.special==='lineH'){ 
                this.ctx.beginPath(); 
                this.ctx.moveTo(cx+8,cy+this.tileSize/2); 
                this.ctx.lineTo(cx+this.tileSize-8,cy+this.tileSize/2); 
                this.ctx.stroke(); 
            }
            else if(gem.special==='lineV'){ 
                this.ctx.beginPath(); 
                this.ctx.moveTo(cx+this.tileSize/2,cy+8); 
                this.ctx.lineTo(cx+this.tileSize/2,cy+this.tileSize-8); 
                this.ctx.stroke(); 
            }
            else if(gem.special==='color'){ 
                this.ctx.fillStyle='rgba(255,255,255,0.75)'; 
                this.ctx.beginPath(); 
                this.ctx.arc(cx+this.tileSize/2,cy+this.tileSize/2,this.tileSize/5,0,Math.PI*2); 
                this.ctx.fill(); 
            }
            
            this.ctx.restore();
        }
    drawObstacle(x,y,cell){ const cx=x*this.tileSize; const cy=y*this.tileSize; this.ctx.fillStyle='#555'; this.ctx.fillRect(cx+4,cy+4,this.tileSize-8,this.tileSize-8); this.ctx.strokeStyle='#999'; this.ctx.strokeRect(cx+4,cy+4,this.tileSize-8,this.tileSize-8); this.ctx.fillStyle='#fff'; this.ctx.font='bold 16px sans-serif'; this.ctx.fillText(cell.hp,cx+this.tileSize/2-5,cy+this.tileSize/2+6); }
    drawIce(x,y){ const cx=x*this.tileSize; const cy=y*this.tileSize; this.ctx.strokeStyle='rgba(173,216,230,0.8)'; this.ctx.lineWidth=3; this.ctx.strokeRect(cx+3,cy+3,this.tileSize-6,this.tileSize-6); }
    render(){ if(!this.ctx) return; this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height); this.ctx.strokeStyle='#2225'; this.ctx.lineWidth=1; for(let x=0;x<=this.gridSize;x++){ this.ctx.beginPath(); this.ctx.moveTo(x*this.tileSize,0); this.ctx.lineTo(x*this.tileSize,this.gridSize*this.tileSize); this.ctx.stroke(); } for(let y=0;y<=this.gridSize;y++){ this.ctx.beginPath(); this.ctx.moveTo(0,y*this.tileSize); this.ctx.lineTo(this.gridSize*this.tileSize,y*this.tileSize); this.ctx.stroke(); } for(let y=0;y<this.gridSize;y++) for(let x=0;x<this.gridSize;x++){ const cell=this.grid[y][x]; if(!cell) continue; if(cell.obstacle==='stone') this.drawObstacle(x,y,cell); else { this.drawGem(x,y,cell.type); if(cell.locked) this.drawIce(x,y); } } if(this.selectedGem){ this.ctx.strokeStyle='#ff0000'; this.ctx.lineWidth=3; this.ctx.strokeRect(this.selectedGem.x*this.tileSize+2,this.selectedGem.y*this.tileSize+2,this.tileSize-4,this.tileSize-4); } this.updateParticles(); this.particles.forEach(p=>{ this.ctx.globalAlpha=Math.max(0,p.life/35); this.ctx.fillStyle=p.color; this.ctx.fillRect(p.x-2,p.y-2,4,4); this.ctx.globalAlpha=1; }); this.effects.forEach(e=>{ const alpha=1-e.progress; this.ctx.save(); this.ctx.globalAlpha=alpha; const pulse=(Math.sin(e.progress*10)+1)/2; if(e.orientation==='h'){ const y=e.index*this.tileSize; this.ctx.fillStyle=`rgba(255,255,0,${0.35+0.35*pulse})`; this.ctx.fillRect(0,y,this.gridSize*this.tileSize,this.tileSize); } else { const x=e.index*this.tileSize; this.ctx.fillStyle=`rgba(255,255,0,${0.35+0.35*pulse})`; this.ctx.fillRect(x,0,this.tileSize,this.gridSize*this.tileSize); } this.ctx.restore(); }); requestAnimationFrame(()=>this.render()); }
    // æ§åˆ¶
    restartGame(){
        const lvl=this.levelId==='è‡ªç”±'?0:this.levelId;
        if(confirm('é‡æ–°å¼€å§‹å½“å‰å…³å¡?')){
            this.startLevel(lvl);
        }
    }
}
// é‡æ–°å®šä¹‰ initGame ä½äºç±»å¤–
function initGame(){
    debugLog('åˆå§‹åŒ–æ¸¸æˆå¼•æ“...');
    try {
        GameEngine=new SimpleGameEngine();
        const q=id=>document.getElementById(id);
        q('startGameBtn').onclick=()=>{ GameEngine.ensureAudioUnlock(); SimpleUI.startLevel(1); };
        q('levelSelectBtn').onclick=()=>SimpleUI.showScreen('levelSelect');
        q('freePlayBtn').onclick=()=>{ GameEngine.ensureAudioUnlock(); SimpleUI.startLevel(0); };
        q('backToMenuBtn').onclick=()=>SimpleUI.showScreen('mainMenu');
        q('restartBtn').onclick=()=>GameEngine.restartGame();
        q('backToLevelSelectBtn').onclick=()=>SimpleUI.showScreen('levelSelect');
        q('muteBtn').onclick=()=>GameEngine.toggleMute();
        q('toolShuffle').onclick=()=>GameEngine.activateTool('shuffle');
        q('toolColorBomb').onclick=()=>GameEngine.activateTool('color');
        const audioFileInput=q('audioFileInput');
        q('loadAudioBtn').onclick=()=>{ GameEngine.loadAudioPack('9439'); audioFileInput.click(); };
        audioFileInput.onchange=e=>{ const files=[...e.target.files]; if(!files.length) return; const map={'bg':'bgMusic','pop':'popSound','combo':'comboSound','win':'winSound','lose':'loseSound'}; files.forEach(f=>{ const name=f.name.toLowerCase(); for(const k in map){ if(name.includes(k)){ const el=q(map[k]); el.src=URL.createObjectURL(f); el.load(); break;} } }); GameEngine.showTip('ğŸµ è‡ªå®šä¹‰éŸ³æ•ˆå·²åŠ è½½',250,220); GameEngine.ensureAudioUnlock(); };
        debugLog('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ'); setTimeout(()=>{const d=q('debugInfo'); if(d) d.style.display='none';},1200);
    }catch(e){ console.error(e); showError('åˆå§‹åŒ–å¤±è´¥: '+e.message);} }

        // å…¨å±€é”™è¯¯ç›‘å¬
        window.addEventListener('error', e=>{
            console.error(e.error||e.message);
            debugLog('è„šæœ¬é”™è¯¯: '+e.message,'error');
        });
        window.addEventListener('unhandledrejection', e=>{
            console.error(e.reason);
            debugLog('æœªå¤„ç†Promise: '+e.reason,'error');
        });
        
        // åˆ›å»ºç›®å½•æ£€æŸ¥å‡½æ•°
        function checkResourcePaths() {
            console.log("=== å¼€å§‹æ£€æŸ¥èµ„æºè·¯å¾„ ===");
            debugLog("æ£€æŸ¥èµ„æºç›®å½•å’Œæ–‡ä»¶å¯è®¿é—®æ€§...");
            
            // æ£€æŸ¥å›¾ç‰‡è·¯å¾„
            for(let i = 0; i < 3; i++) {
                const testImage = new Image();
                const imgPath = `images/gem${i}.png`;
                
                testImage.onload = () => {
                    console.log(`âœ“ å›¾ç‰‡è·¯å¾„æ­£å¸¸: ${imgPath} å¯ä»¥è®¿é—®`);
                    if(i === 0) debugLog("å›¾ç‰‡èµ„æºç›®å½•å¯è®¿é—®");
                };
                
                testImage.onerror = () => {
                    console.error(`âœ— å›¾ç‰‡è·¯å¾„é”™è¯¯: ${imgPath} æ— æ³•è®¿é—®`);
                    if(i === 0) debugLog("è­¦å‘Š: images ç›®å½•å¯èƒ½ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®");
                };
                
                testImage.src = imgPath;
            }
            
            // æ£€æŸ¥éŸ³é¢‘è·¯å¾„
            const testAudio = new Audio();
            testAudio.oncanplaythrough = () => {
                console.log("âœ“ éŸ³é¢‘è·¯å¾„æ­£å¸¸: audio/9439/bg.mp3 å¯ä»¥è®¿é—®");
                debugLog("éŸ³é¢‘èµ„æºç›®å½•å¯è®¿é—®");
            };
            testAudio.onerror = () => {
                console.error("âœ— éŸ³é¢‘è·¯å¾„é”™è¯¯: audio/9439/bg.mp3 æ— æ³•è®¿é—®");
                debugLog("è­¦å‘Š: audio/9439 ç›®å½•å¯èƒ½ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®");
            };
            testAudio.src = "audio/9439/bg.mp3";
            
            // åˆ›å»ºç›®å½•ç»“æ„æç¤º
            setTimeout(() => {
                console.log("=== èµ„æºç›®å½•ç»“æ„è¦æ±‚ ===");
                console.log("è¯·ç¡®ä¿ä»¥ä¸‹ç›®å½•ç»“æ„å­˜åœ¨:");
                console.log("æ¶ˆæ¶ˆä¹/");
                console.log("â”œâ”€â”€ game-ultimate.html");
                console.log("â”œâ”€â”€ images/");
                console.log("â”‚   â”œâ”€â”€ gem0.png  (çº¢è‰²å®çŸ³)");
                console.log("â”‚   â”œâ”€â”€ gem1.png  (è“è‰²å®çŸ³)");
                console.log("â”‚   â”œâ”€â”€ gem2.png  (ç»¿è‰²å®çŸ³)");
                console.log("â”‚   â”œâ”€â”€ gem3.png  (é»„è‰²å®çŸ³)");
                console.log("â”‚   â”œâ”€â”€ gem4.png  (ç´«è‰²å®çŸ³)");
                console.log("â”‚   â”œâ”€â”€ gem5.png  (æ©™è‰²å®çŸ³)");
                console.log("â”‚   â”œâ”€â”€ gem6.png  (é’è‰²å®çŸ³)");
                console.log("â”‚   â”œâ”€â”€ gem7.png  (æµ…ç»¿å®çŸ³)");
                console.log("â”‚   â””â”€â”€ gem8.png  (ç²‰è‰²å®çŸ³)");
                console.log("â””â”€â”€ audio/");
                console.log("    â””â”€â”€ 9439/");
                console.log("        â”œâ”€â”€ bg.mp3    (èƒŒæ™¯éŸ³ä¹)");
                console.log("        â”œâ”€â”€ pop.mp3   (æ¶ˆé™¤éŸ³æ•ˆ)");
                console.log("        â”œâ”€â”€ combo.mp3 (è¿å‡»éŸ³æ•ˆ)");
                console.log("        â”œâ”€â”€ win.mp3   (èƒœåˆ©éŸ³æ•ˆ)");
                console.log("        â””â”€â”€ lose.mp3  (å¤±è´¥éŸ³æ•ˆ)");
                console.log("=== æ³¨æ„äº‹é¡¹ ===");
                console.log("1. ç¡®ä¿æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åå®Œå…¨åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰");
                console.log("2. å›¾ç‰‡æ–‡ä»¶å¿…é¡»æ˜¯PNGæ ¼å¼");
                console.log("3. éŸ³é¢‘æ–‡ä»¶å¿…é¡»æ˜¯MP3æ ¼å¼");
                console.log("4. å¦‚æœç¼ºå°‘æ–‡ä»¶ï¼Œæ¸¸æˆä¼šè‡ªåŠ¨ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ");
            }, 1500);
        }
        
        // DOM å‡†å¤‡åå¯åŠ¨
        if(document.readyState==='loading'){
            document.addEventListener('DOMContentLoaded', () => {
                checkResourcePaths();
                initGame();
            });
        } else {
            checkResourcePaths();
            initGame();
        }
    </script>
</body>
</html>
